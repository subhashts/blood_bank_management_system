{% extends "base.html" %}

{% block title %}Patient Dashboard - Blood Management System{% endblock %}

{% block content %}
<div class="container py-4">
<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
{{ message }}
<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<!-- Welcome Header -->
<div class="row mb-4">
<div class="col-12">
<div class="card bg-gradient-danger text-white">
<div class="card-body d-flex justify-content-between align-items-center">
<div>
<h2 class="mb-0">
<i class="fas fa-user me-2"></i>Welcome, {{ current_user.name }}
</h2>
<p class="mb-0">Blood Group: <span class="badge bg-light text-dark">{{ current_user.blood_group }}</span></p>
</div>
<div class="text-end">
<small class="d-block">Member since</small>
<strong>{{ current_user.created_at.strftime('%b %d, %Y') if current_user.created_at else '' }}</strong>
</div>
</div>
</div>
</div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
<div class="col-md-4 mb-3">
<div class="card border-warning">
<div class="card-body text-center">
<i class="fas fa-clock fa-2x text-warning mb-2"></i>
<h4 class="text-warning">{{ pending_requests }}</h4>
<p class="mb-0">Pending Blood Requests</p>
</div>
</div>
</div>
<div class="col-md-4 mb-3">
<div class="card border-info">
<div class="card-body text-center">
<i class="fas fa-heart fa-2x text-info mb-2"></i>
<h4 class="text-info">{{ pending_donations }}</h4>
<p class="mb-0">Pending Donations</p>
</div>
</div>
</div>
<div class="col-md-4 mb-3">
<div class="card border-success">
<div class="card-body text-center">
<i class="fas fa-hand-holding-heart fa-2x text-success mb-2"></i>
<h4 class="text-success">{{ (my_requests|length if my_requests is defined else 0) }}</h4>
<p class="mb-0">Total Requests</p>
</div>
</div>
</div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
<div class="col-12">
<div class="card">
<div class="card-header bg-danger text-white">
<h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
</div>
<div class="card-body">
<div class="row g-3 justify-content-start">
<!-- Keep them aligned horizontally -->
<div class="col-lg-2 col-md-4 col-sm-6">
    <a href="{{ url_for('patient.my_donations') }}" class="btn btn-outline-success w-100 h-100 d-flex flex-column justify-content-center align-items-center p-3">
        <i class="fas fa-tint fa-2x mb-2"></i>
        <span>My Donations</span>
    </a>
</div>


<div class="col-lg-2 col-md-3 col-sm-6">
<a href="{{ url_for('patient.donate_blood') }}" class="btn btn-outline-success w-100 h-100 d-flex flex-column justify-content-center align-items-center p-3">
<i class="fas fa-heart fa-2x mb-2"></i>
<span>Donate Blood</span>
</a>
</div>

<div class="col-lg-2 col-md-3 col-sm-6">
<a href="{{ url_for('patient.register_camp') }}" class="btn btn-outline-info w-100 h-100 d-flex flex-column justify-content-center align-items-center p-3">
<i class="fas fa-campground fa-2x mb-2"></i>
<span>Join Camp</span>
</a>
</div>

<div class="col-lg-2 col-md-3 col-sm-6">
<a href="{{ url_for('patient.my_requests') }}" class="btn btn-outline-warning w-100 h-100 d-flex flex-column justify-content-center align-items-center p-3">
<i class="fas fa-list fa-2x mb-2"></i>
<span>My Requests</span>
</a>
</div>

<div class="col-lg-2 col-md-3 col-sm-6">
<a href="{{ url_for('patient.request_blood') }}" class="btn btn-outline-primary w-100 h-100 d-flex flex-column justify-content-center align-items-center p-3">
<i class="fas fa-tint fa-2x mb-2"></i>
<span>Request Blood</span>
</a>
</div>

<div class="col-lg-2 col-md-3 col-sm-6">
<a href="{{ url_for('patient.list_hospitals') }}" class="btn btn-outline-secondary w-100 h-100 d-flex flex-column justify-content-center align-items-center p-3">
<i class="fas fa-map-marker-alt fa-2x mb-2"></i>
<span>Nearby Hospitals</span>
</a>
</div>
</div>
</div>
</div>
</div>
</div>


<!-- Hospitals list (direct request option) -->
<div class="row mb-4">
<div class="col-12">
<div class="card">
<div class="card-body">
{% if hospitals %}
<div class="table-responsive">
<table class="table table-hover">
<thead>
<tr>
<th>Hospital</th>
<th>City</th>
<th>Available Groups</th>
<th class="text-end">Action</th>
</tr>
</thead>
<tbody>
{% for hospital in hospitals %}
<tr>
<td>{{ hospital.hospital_name }}</td>
<td>{{ hospital.city.name if hospital.city is defined else hospital.city }}</td>
<td>
{% if hospital.available_groups is defined %}
{{ hospital.available_groups }}
{% else %}
View
{% endif %}
</td>
<td class="text-end">
<a href="{{ url_for('patient.request_blood_from_hospital', hospital_id=hospital.id) }}" class="btn btn-sm btn-success">
Request from this Hospital
</a>
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
{% endif %}
</div>
</div>
</div>
</div>

<!-- Recent Activities -->
<div class="row">
<div class="col-12">
<div class="card">
<div class="card-header bg-primary text-white">
<h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Activities</h5>
</div>
<div class="card-body">
{% if recent_activities %}
<div class="list-group list-group-flush">
{% for activity in recent_activities %}
<div class="list-group-item d-flex justify-content-between align-items-start">
<div class="ms-2 me-auto">
<div class="fw-bold">
{% if activity.activity_type == 'donation' %}
<i class="fas fa-heart text-success me-2"></i>Blood Donation
{% elif activity.activity_type == 'request' %}
<i class="fas fa-plus text-danger me-2"></i>Blood Request
{% elif activity.activity_type == 'camp_registration' %}
<i class="fas fa-campground text-info me-2"></i>Camp Registration
{% else %}
<i class="fas fa-info-circle me-2"></i>{{ activity.activity_type|capitalize }}
{% endif %}
</div>
<p class="mb-1">{{ activity.description }}</p>

{% if activity.activity_type == 'donation' and activity.status == 'approved' and activity.certificate_generated %}
<a href="{{ url_for('patient.download_certificate', donation_id=activity.donation_id) }}" class="btn btn-sm btn-outline-primary mt-2">
<i class="fas fa-download me-1"></i> Download Certificate
</a>
{% endif %}
</div>
<small class="text-muted">{{ activity.created_at.strftime('%b %d, %Y') }}</small>
</div>
{% endfor %}
</div>
{% else %}
<div class="text-center py-4">
<i class="fas fa-history fa-3x text-muted mb-3"></i>
<h5 class="text-muted">No recent activities</h5>
<p class="text-muted">Start by searching for blood or scheduling a donation.</p>
</div>
{% endif %}
</div>
</div>
</div>
</div>

</div>
{% endblock %}